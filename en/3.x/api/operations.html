<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  <meta name="docsearch:version" content="3.x" />
  <meta name="docsearch:language" content="en" />
  
    <title>Writing Operations &#8212; pyinfra  documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="../_static/guzzle.css?v=1c50d839" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/logo_small.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing Facts" href="facts.html" />
    <link rel="prev" title="Packaging Deploys" href="deploys.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="facts.html" title="Writing Facts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="deploys.html" title="Packaging Deploys"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Writing Operations</a></li> 
      </ul>
    </div>
  <div class="container-wrapper">
    <header>
      <nav>
        <a target="_blank" href="https://pyinfra.com">pyinfra.com<span class="glyphicon glyphicon glyphicon-share" aria-hidden="true"></span></a>
        <a target="_blank" href="https://github.com/Fizzadar/pyinfra">GitHub<span class="glyphicon glyphicon glyphicon-share" aria-hidden="true"></span></a>
      </nav>

      <div id="header-sidebar">
        <a href="../index.html" class="text-logo">
            <img src="../_static/logo_small.png" />
            pyinfra <small>3.x</small>
        </a>
        
<form id="main-search" class="form-inline" action="../search.html" method="GET" role="form">
  <div id="docsearch">
    <input id="search-input" name="q" type="text" class="form-control" placeholder="Search...">
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </div>
</form>
      </div>

      <div id="mobile-toggle">
        <a id="toggle-menu" href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
        <a href="../index.html" class="text-logo">
            <img src="../_static/logo_small.png" />
        </a>
      </div>
    </header>
    <div id="left-column">
      <div class="sphinxsidebar">
        <div class="sidebar-block">
    <div class="sidebar-toc">
        <p class="caption" role="heading"><span class="caption-text">Using pyinfra</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-operations.html">Using Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inventory-data.html">Inventory &amp; Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arguments.html">Global Arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Using the CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deploy Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operations.html">Operations Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facts.html">Facts Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connectors.html">Connectors Index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How pyinfra Works</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../deploy-process.html">How pyinfra Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploys.html">Packaging Deploys</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing Operations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#input-arguments">Input: arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="#output-commands">Output: commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-managing-files">Example: managing files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="facts.html">Writing Facts</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectors.html">Writing Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Using the API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Meta</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Help &amp; Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compatibility.html">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes.html">Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API Reference</a></li>
</ul>

    </div>
</div>
      </div>
    </div>
    
      <div id="right-column">
        
        <div class="document clearer body" role="main">
          
  <section id="writing-operations">
<h1>Writing Operations<a class="headerlink" href="#writing-operations" title="Link to this heading">¶</a></h1>
<p><a class="reference internal" href="../operations.html"><span class="doc std std-doc">Operations</span></a> are defined as Python functions. They are passed the current deploy state, the target host, and any operation arguments. Operation functions read state from the host, compare it to the arguments, and yield commands.</p>
<section id="input-arguments">
<h2>Input: arguments<a class="headerlink" href="#input-arguments" title="Link to this heading">¶</a></h2>
<p>Operations can accept any arguments except <code class="docutils literal notranslate"><span class="pre">name</span></code> and those starting with <code class="docutils literal notranslate"><span class="pre">_</span></code> which are reserved for internal use.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@operation</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_operation</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="output-commands">
<h2>Output: commands<a class="headerlink" href="#output-commands" title="Link to this heading">¶</a></h2>
<p>Operations are generator functions and <code class="docutils literal notranslate"><span class="pre">yield</span></code> three types of command:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell commands, simply represented by a string OR the `StringCommand` class</span>
<span class="k">yield</span> <span class="n">StringCommand</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;Shell!&quot;</span><span class="p">)</span>

<span class="c1"># File uploads represented by the `FileUploadCommand` class</span>
<span class="k">yield</span> <span class="n">FileUploadCommand</span><span class="p">(</span><span class="n">filename_or_io</span><span class="p">,</span> <span class="n">remote_filename</span><span class="p">)</span>

<span class="c1"># File downloads represented by the `FileDownloadCommand` class</span>
<span class="k">yield</span> <span class="n">FileDownloadCommand</span><span class="p">(</span><span class="n">remote_filename</span><span class="p">,</span> <span class="n">filename_or_io</span><span class="p">)</span>

<span class="c1"># Python functions represented by the `FunctionCommand` class</span>
<span class="k">yield</span> <span class="n">FunctionCommand</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">kwargs_dict</span><span class="p">)</span>

<span class="c1"># Additionally, commands can override most global arguments</span>
<span class="k">yield</span> <span class="n">StringCommand</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;Shell!&quot;</span><span class="p">,</span> <span class="n">_sudo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Operations can also call other operations using <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span> <span class="pre">&lt;operation&gt;._inner</span></code> syntax.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">yield from</span> <span class="n">files</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">_inner</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/some/file&quot;</span><span class="p">,</span>
    <span class="o">...</span><span class="p">,</span>

    <span class="c1"># Only arguments for the operation itself are allowed, global arguments</span>
    <span class="c1"># such as e.g. _sudo are not accepted.</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-managing-files">
<h2>Example: managing files<a class="headerlink" href="#example-managing-files" title="Link to this heading">¶</a></h2>
<p>This is a simplified version of the <code class="docutils literal notranslate"><span class="pre">files.file</span></code> operation, which will create/remove a
remote file based on the <code class="docutils literal notranslate"><span class="pre">present</span></code> kwargs:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyinfra</span><span class="w"> </span><span class="kn">import</span> <span class="n">host</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyinfra.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">operation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyinfra.facts.files</span><span class="w"> </span><span class="kn">import</span> <span class="n">File</span>

<span class="nd">@operation</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">present</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Manage the state of files.</span>

<span class="sd">    + path: name/path of the remote file</span>
<span class="sd">    + present: whether the file should exist</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">get_fact</span><span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Not a file?!</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">OperationError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> exists and is not a file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="c1"># Doesn&#39;t exist &amp; we want it</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">present</span><span class="p">:</span>
        <span class="k">yield</span> <span class="s2">&quot;touch </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># It exists and we don&#39;t want it</span>
    <span class="k">elif</span> <span class="n">info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">present</span><span class="p">:</span>
        <span class="k">yield</span> <span class="s2">&quot;rm -f </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


        </div>
          
  <nav class="footer-relations">
    <ul class="pager">
      
        <li class="previous"><a href="deploys.html">
          <span aria-hidden="true">&larr;</span> Packaging Deploys
        </a></li>
      
        <li class="next"><a href="facts.html">
          Writing Facts <span aria-hidden="true">&rarr;</span>
        </a></li>
      
    </ul>
  </nav>
    <div class="clearer"></div>
  
      </div>
      <div class="clearfix"></div>
  </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="facts.html" title="Writing Facts"
             >next</a> |</li>
        <li class="right" >
          <a href="deploys.html" title="Packaging Deploys"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Writing Operations</a></li> 
      </ul>
    </div>
<script type="text/javascript" src="../_static/js/jquery.min.js"></script>
<script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
<script type="text/javascript">
  $("a#toggle-menu").click(function () {
    $("#left-column").slideToggle(100);
  });

  var currentIndexItem = document.querySelector('ul.current ul.current li.current');
  if (currentIndexItem) {
    currentIndexItem.scrollIntoView({'block': 'center'});
  }
</script>
  <div class="footer">
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
  <script type="text/javascript">
    docsearch({
        apiKey: '25a25b5f5310f306641f9ce07dcb06eb',
        appId: 'XXGX6EX4KA',
        indexName: 'pyinfra',
        container: '#docsearch',
        searchParameters: {
          facetFilters: ["version:3.x", "lang:en"],
        },
        debug: false,
    });
  </script>



  
    <script async defer data-domain="docs.pyinfra.com" src="https://stats.oxygem.com/js/index.js"></script>
  

  </body>
</html>