
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
  
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <meta name="docsearch:version" content="latest" />
  <meta name="docsearch:language" content="en" />
  
    <title>Writing Operations &#8212; pyinfra  documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/logo_small.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing Facts" href="facts.html" />
    <link rel="prev" title="Writing Connectors" href="connectors.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="facts.html" title="Writing Facts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="connectors.html" title="Writing Connectors"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li> 
      </ul>
    </div>
  <div class="container-wrapper">
    <header>
      <nav>
        <a target="_blank" href="https://pyinfra.com">pyinfra.com<span class="glyphicon glyphicon glyphicon-share" aria-hidden="true"></span></a>
        <a target="_blank" href="https://github.com/Fizzadar/pyinfra">GitHub<span class="glyphicon glyphicon glyphicon-share" aria-hidden="true"></span></a>
      </nav>

      <div id="header-sidebar">
        <a href="../index.html" class="text-logo">
            <img src="../_static/logo_small.png" />
            pyinfra <small>latest</small>
        </a>
        
<form id="main-search" class="form-inline" action="../search.html" method="GET" role="form">
  <input id="docsearch-input" name="q" type="text" class="form-control" placeholder="Search...">
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div id="mobile-toggle">
        <a id="toggle-menu" href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
        <a href="../index.html" class="text-logo">
            <img src="../_static/logo_small.png" />
        </a>
      </div>
    </header>
    <div id="left-column">
      <div class="sphinxsidebar">
        <div class="sidebar-block">
    <div class="sidebar-toc">
        <p class="caption"><span class="caption-text">Using pyinfra</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-operations.html">Using Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inventory-data.html">Inventory &amp; Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arguments.html">Global Arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Using the CLI</a></li>
</ul>
<p class="caption"><span class="caption-text">Deploy Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Example Deploys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connectors.html">Connectors Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operations.html">Operations Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facts.html">Facts Index</a></li>
</ul>
<p class="caption"><span class="caption-text">How pyinfra Works</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="deploys.html">Packaging Deploys</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectors.html">Writing Connectors</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing Operations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#input-arguments">Input: arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="#output-commands">Output: commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-managing-files">Example: managing files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="facts.html">Writing Facts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy-process.html">Deploy Execution</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Help &amp; Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compatibility.html">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API Reference</a></li>
</ul>

    </div>
</div>
      </div>
    </div>
    
      <div id="right-column">
        
          
            <div class="admonition important">
                <p class="first admonition-title">Documentation may contain unreleased features!</p>
                <p>You are reading most recent documentation which may not have been released yet. <a href="/en/2.x/api/operations.html"><strong>2.x</strong></a> is the latest release version available.</p>
            </div>
          
        
        <div class="document clearer body" role="main">
          
  <div class="section" id="writing-operations">
<h1>Writing Operations<a class="headerlink" href="#writing-operations" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="../operations.html"><span class="doc">Operations</span></a> are defined as Python functions. They are passed the current deploy state, the target host and any operation arguments. Operation functions read state from the host, comparing it to the arguments, and yield <strong>commands</strong>.</p>
<div class="section" id="input-arguments">
<h2>Input: arguments<a class="headerlink" href="#input-arguments" title="Permalink to this headline">¶</a></h2>
<p>Operations can accept any arguments except those starting with <code class="docutils literal notranslate"><span class="pre">_</span></code> which are reserved for internal use.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@operation</span>
<span class="k">def</span> <span class="nf">my_operation</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="output-commands">
<h2>Output: commands<a class="headerlink" href="#output-commands" title="Permalink to this headline">¶</a></h2>
<p>Operations are generator functions and <code class="docutils literal notranslate"><span class="pre">yield</span></code> three types of command:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell commands, simply represented by a string OR the `StringCommand` class</span>
<span class="k">yield</span> <span class="s1">&#39;echo &quot;Shell!&quot;&#39;</span>
<span class="k">yield</span> <span class="n">StringCommand</span><span class="p">(</span><span class="s1">&#39;echo &quot;Shell!&quot;&#39;</span><span class="p">)</span>

<span class="c1"># File uploads represented by the `FileUploadCommand` class</span>
<span class="k">yield</span> <span class="n">FileUploadCommand</span><span class="p">(</span><span class="n">filename_or_io</span><span class="p">,</span> <span class="n">remote_filename</span><span class="p">)</span>

<span class="c1"># File downloads represented by the `FileDownloadCommand` class</span>
<span class="k">yield</span> <span class="n">FileDownloadCommand</span><span class="p">(</span><span class="n">remote_filename</span><span class="p">,</span> <span class="n">filename_or_io</span><span class="p">)</span>

<span class="c1"># Python functions represented by the `FunctionCommand` class</span>
<span class="k">yield</span> <span class="n">FunctionCommand</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">kwargs_dict</span><span class="p">)</span>

<span class="c1"># Additionally, commands can override some of the global arguments</span>
<span class="k">yield</span> <span class="n">StringCommand</span><span class="p">(</span><span class="s1">&#39;echo &quot;Shell!&quot;&#39;</span><span class="p">,</span> <span class="n">sudo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="example-managing-files">
<h2>Example: managing files<a class="headerlink" href="#example-managing-files" title="Permalink to this headline">¶</a></h2>
<p>This is a simplified version of the <code class="docutils literal notranslate"><span class="pre">files.file</span></code> operation, which will create/remove a
remote file based on the <code class="docutils literal notranslate"><span class="pre">present</span></code> kwargs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyinfra</span> <span class="kn">import</span> <span class="n">host</span>
<span class="kn">from</span> <span class="nn">pyinfra.api</span> <span class="kn">import</span> <span class="n">operation</span>
<span class="kn">from</span> <span class="nn">pyinfra.facts.files</span> <span class="kn">import</span> <span class="n">File</span>

<span class="nd">@operation</span>
<span class="k">def</span> <span class="nf">file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">present</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Manage the state of files.</span>

<span class="sd">    + name: name/path of the remote file</span>
<span class="sd">    + present: whether the file should exist</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">get_fact</span><span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Not a file?!</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">OperationError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> exists and is not a file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="c1"># Doesn&#39;t exist &amp; we want it</span>
    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">present</span><span class="p">:</span>
        <span class="k">yield</span> <span class="s1">&#39;touch </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># It exists and we don&#39;t want it</span>
    <span class="k">elif</span> <span class="n">info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">present</span><span class="p">:</span>
        <span class="k">yield</span> <span class="s1">&#39;rm -f </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


        </div>
          
  <nav class="footer-relations">
    <ul class="pager">
      
        <li class="previous"><a href="connectors.html">
          <span aria-hidden="true">&larr;</span> Writing Connectors
        </a></li>
      
        <li class="next"><a href="facts.html">
          Writing Facts <span aria-hidden="true">&rarr;</span>
        </a></li>
      
    </ul>
  </nav>
    <div class="clearer"></div>
  
      </div>
      <div class="clearfix"></div>
  </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="facts.html" title="Writing Facts"
             >next</a> |</li>
        <li class="right" >
          <a href="connectors.html" title="Writing Connectors"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("a#toggle-menu").click(function () {
    $("#left-column").slideToggle(100);
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
  </div>


  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  <script type="text/javascript"> docsearch({
      apiKey: 'e2522266be34dfb8a0044c09cbf4c8b3',
      indexName: 'pyinfra',
      inputSelector: '#docsearch-input',
      algoliaOptions: {
        'facetFilters': ["version:latest", "lang:en"],
      },
      debug: false,
  });
  </script>



  
    <script async defer data-domain="docs.pyinfra.com" src="https://stats.oxygem.com/js/index.js"></script>
  

  </body>
</html>